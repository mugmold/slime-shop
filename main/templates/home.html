{% extends 'base_navbar.html' %}
{% load static %}

{% block meta %}
<title>Home - Slime Shop</title>
{% endblock meta %}

{% block main_content %}

<header class="flex items-center justify-between pb-4 border-b-2 border-gray-200 mb-6">
    <div>
        <h1 class="text-3xl font-bold text-gray-800">Welcome, {{ user.username }}!</h1>
        <p class="mt-1 text-sm text-gray-500">Last login: {{ last_login }}</p>
    </div>
    <button id="add-product-button"
        class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-600 transition duration-150 ease-in-out flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                clip-rule="evenodd" />
        </svg>
        Add Product
    </button>
</header>

<div id="toast-container" class="fixed bottom-5 right-5 z-50 w-full max-w-sm"></div>

<div class="mb-8">
    <p class="text-lg font-semibold text-gray-700 mb-2">Browse Products</p>
    <div class="flex space-x-2">
        <button id="filter-all-btn" type="button"
            class="px-4 py-2 text-sm font-medium rounded-md transition bg-emerald-500 text-white shadow">All Products
        </button>
        <button id="filter-my-btn" type="button"
            class="px-4 py-2 text-sm font-medium rounded-md transition bg-gray-200 text-gray-700 hover:bg-gray-300">My
            Products
        </button>
    </div>
</div>

<div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
</div>

<div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Add New Product</h3>
            <div class="mt-2 px-7 py-3">
                <form id="add-product-form" method="POST">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <input type="text" name="name" placeholder="Name" class="w-full px-3 py-2 border rounded-md"
                            required>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" name="price" placeholder="Price"
                                class="w-full px-3 py-2 border rounded-md" required>
                            <input type="number" name="stock" placeholder="Stock"
                                class="w-full px-3 py-2 border rounded-md" required>
                        </div>
                        <textarea name="description" placeholder="Description" rows="4"
                            class="w-full px-3 py-2 border rounded-md"></textarea>
                        <input type="url" name="thumbnail" placeholder="Thumbnail URL (https://...)"
                            class="w-full px-3 py-2 border rounded-md">
                        <input type="text" name="category" placeholder="Category"
                            class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="close-modal-button"
                            class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
                        <button type="submit"
                            class="px-4 py-2 bg-emerald-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-emerald-600">Add
                            Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="edit-product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Edit Product</h3>
            <div class="mt-2 px-7 py-3">
                <form id="edit-product-form" method="POST">
                    <input type="hidden" name="id" id="edit-product-id">
                    <div class="space-y-4">
                        <input type="text" name="name" id="edit_name" placeholder="Name"
                            class="w-full px-3 py-2 border rounded-md" required>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" name="price" id="edit_price" placeholder="Price"
                                class="w-full px-3 py-2 border rounded-md" required>
                            <input type="number" name="stock" id="edit_stock" placeholder="Stock"
                                class="w-full px-3 py-2 border rounded-md" required>
                        </div>
                        <textarea name="description" id="edit_description" placeholder="Description" rows="4"
                            class="w-full px-3 py-2 border rounded-md"></textarea>
                        <input type="url" name="thumbnail" id="edit_thumbnail" placeholder="Thumbnail URL (https://...)"
                            class="w-full px-3 py-2 border rounded-md">
                        <input type="text" name="category" id="edit_category" placeholder="Category"
                            class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="close-edit-modal-button"
                            class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700">Save
                            Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="delete-confirm-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Delete Product</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to delete this product? This action cannot be
                    undone.</p>
            </div>
            <div class="items-center px-4 py-3 space-x-4">
                <button id="cancel-delete-btn"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
</div>

<div id="detail-product-modal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-4 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div id="detail-modal-content">
            <p class="text-center p-8">Loading product details...</p>
        </div>
        <div class="mt-4 text-right">
            <button id="close-detail-modal-button"
                class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">
                Close
            </button>
        </div>
    </div>
</div>


{{ request.user.id|json_script:"user_id" }}
{{ django_messages|json_script:"django_messages" }}

<script>
    // ambil id user
    const currentUserId = JSON.parse(document.getElementById('user_id').textContent);

    // ambil product & show
    async function getProducts(filterType = 'all') {
        let url = "{% url 'main:show_json' %}";
        // logika filter button anda tetap sama
        const allBtn = document.getElementById('filter-all-btn');
        const myBtn = document.getElementById('filter-my-btn');
        allBtn.className = "px-4 py-2 text-sm font-medium rounded-md transition bg-gray-200 text-gray-700 hover:bg-gray-300";
        myBtn.className = "px-4 py-2 text-sm font-medium rounded-md transition bg-gray-200 text-gray-700 hover:bg-gray-300";

        if (filterType === 'my') {
            url += "?filter=my";
            myBtn.className = "px-4 py-2 text-sm font-medium rounded-md transition bg-emerald-500 text-white shadow";
        } else {
            allBtn.className = "px-4 py-2 text-sm font-medium rounded-md transition bg-emerald-500 text-white shadow";
        }

        let productGrid = document.getElementById("product-grid");

        // tampilin spinner loading sebelum fetch data
        productGrid.innerHTML = `
        <div class="col-span-full flex justify-center items-center py-16">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-emerald-500"></div>
            <p class="ml-4 text-gray-500">Loading products...</p>
        </div>
        `;

        try {
            const response = await fetch(url);
            const products = await response.json();

            // delete spinner sebelum nampilin data baru
            productGrid.innerHTML = "";

            if (products.length === 0) {
                // tampilin pesan "no products found" kalau gada data
                productGrid.innerHTML = `
                <div class="col-span-full text-center py-16 px-6 bg-white rounded-lg shadow-md">
                    <img src="https://api.iconify.design/heroicons/cube-transparent.svg?color=%2334d399" alt="Empty Box" class="mx-auto h-24 w-24 text-gray-400 mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2">No Products Found!</h2>
                    <p class="text-gray-500 mb-6">It looks like there are no products listed in the shop yet. Why not add the first one?</p>
                    <button type="button" id="add-first-product-btn" class="bg-emerald-500 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-emerald-600 transition duration-150 ease-in-out">Add Your First Product</button>
                </div>`;
                document.getElementById('add-first-product-btn').addEventListener('click', () => {
                    document.getElementById('product-modal').style.display = 'block';
                });
                return;
            }

            // tampilin product kalau ada data
            products.forEach((product) => {
                const thumbnailHtml = product.fields.thumbnail ? `<img src="${product.fields.thumbnail}" alt="${product.fields.name}" class="w-full h-48 object-contain bg-gray-100">` : `<div class="w-full h-48 bg-gray-200 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>`;
                const featuredTagHtml = product.fields.is_featured ? `<span class="ml-2 inline-block bg-yellow-200 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Featured!</span>` : "";
                let ownerButtonsHtml = '';
                if (currentUserId === product.fields.user) {
                    ownerButtonsHtml = `<div class="flex space-x-2"><button type="button" class="edit-btn text-xs font-bold py-1.5 px-3 rounded-md transition bg-indigo-100 text-indigo-700 hover:bg-indigo-200" data-id="${product.pk}" data-name="${product.fields.name}" data-price="${product.fields.price}" data-stock="${product.fields.stock}" data-description="${product.fields.description || ''}" data-thumbnail="${product.fields.thumbnail || ''}" data-category="${product.fields.category}">Edit</button><button type="button" class="delete-btn text-xs font-bold py-1.5 px-3 rounded-md transition bg-red-100 text-red-700 hover:bg-red-200" data-id="${product.pk}">Delete</button></div>`;
                }
                const card = document.createElement("div");
                card.className = "bg-white rounded-lg shadow-lg overflow-hidden transition-transform transform hover:-translate-y-1 duration-200 ease-in-out flex flex-col";
                card.innerHTML = `<div class="p-4 flex-grow flex flex-col"><div class="flex-grow"><div class="flex items-center mb-2"><span class="inline-block bg-gray-100 text-gray-600 text-xs font-semibold px-2.5 py-0.5 rounded-full">${product.fields.category}</span>${featuredTagHtml}</div><button type="button" class="view-detail-btn font-bold text-xl text-gray-800 truncate hover:text-emerald-600 transition text-left" data-id="${product.pk}">${product.fields.name}</button><div class="flex justify-between items-center mt-2"><p class="text-lg font-semibold text-emerald-600">Rp${product.fields.price.toLocaleString('id-ID')}</p><p class="text-sm text-gray-500">Stock: ${product.fields.stock}</p></div></div><div class="mt-4 pt-4 border-t flex justify-between items-center"><button type="button" class="view-detail-btn text-sm font-semibold text-emerald-600 hover:text-emerald-700 transition" data-id="${product.pk}">View Details &rarr;</button>${ownerButtonsHtml}</div></div>`;
                card.insertBefore(new DOMParser().parseFromString(thumbnailHtml, 'text/html').body.firstChild, card.firstChild);
                productGrid.appendChild(card);
            });
        } catch (error) {
            productGrid.innerHTML = `
            <div class="col-span-full text-center py-16 px-6 bg-red-50 rounded-lg border border-red-200">
                <h2 class="text-2xl font-semibold text-red-800 mb-2">Oops! Something went wrong.</h2>
                <p class="text-red-600 mb-6">We couldn't load the products. Please try again later.</p>
            </div>
            `;
            console.error("Failed to fetch products:", error);
        }
    }

    // tampilin toast / message
    function showToast(message, tag = 'info') {
        const toastContainer = document.getElementById('toast-container');
        let tagClasses = 'bg-blue-100 border-blue-400 text-blue-800';
        if (tag === 'success') { tagClasses = 'bg-green-100 border-green-400 text-green-800'; }
        else if (tag === 'error') { tagClasses = 'bg-red-100 border-red-400 text-red-800'; }
        const toast = `<div class="p-4 rounded-md text-sm border shadow-lg mb-2 ${tagClasses}" role="alert">${message}</div>`;
        toastContainer.innerHTML = toast;
        setTimeout(() => {
            const toastElement = toastContainer.querySelector('div');
            if (toastElement) {
                toastElement.style.transition = 'opacity 0.5s ease';
                toastElement.style.opacity = '0';
                setTimeout(() => { toastContainer.innerHTML = ''; }, 500);
            }
        }, 5000);
    }

    // panggil semua fungsi pas halaman pertama kali kebuka
    document.addEventListener('DOMContentLoaded', () => {
        const messagesData = JSON.parse(document.getElementById('django_messages').textContent);
        if (messagesData.length > 0) {
            messagesData.forEach(function (message) { showToast(message.message, message.tags); });
        }
        getProducts('all');
    });

    // logic buat modal tambah produk
    const modal = document.getElementById('product-modal');
    const addProductButton = document.getElementById('add-product-button');
    const closeModalButton = document.getElementById('close-modal-button');
    addProductButton.onclick = function () { modal.style.display = "block"; }
    closeModalButton.onclick = function () { modal.style.display = "none"; }
    window.onclick = function (event) { if (event.target == modal) { modal.style.display = "none"; } }

    // submit form tambah produk via ajax
    document.getElementById('add-product-form').addEventListener('submit', async function (event) {
        event.preventDefault(); // mencegah halaman reload pas form disubmit
        const formData = new FormData(this);
        const url = "{% url 'main:create_product_ajax' %}";
        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
            });
            const result = await response.json();
            if (response.status === 201) {
                showToast(result.message || "Product added successfully!", 'success');
                modal.style.display = 'none';
                this.reset();
                getProducts();
            } else {
                showToast(result.message || "Failed to add product. Please check your input again.", 'error');
                console.error('Form errors:', result.errors);
            }
        } catch (error) {
            showToast("A connection error occurred.", 'error');
            console.error('Error:', error);
        }
    });

    // event listener buat filter button
    const allBtn = document.getElementById('filter-all-btn');
    const myBtn = document.getElementById('filter-my-btn');
    allBtn.addEventListener('click', () => { getProducts('all'); });
    myBtn.addEventListener('click', () => { getProducts('my'); });

    // logic buat modal edit produk
    const editModal = document.getElementById('edit-product-modal');
    const closeEditModalButton = document.getElementById('close-edit-modal-button');
    document.getElementById('product-grid').addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('edit-btn')) {
            const button = event.target;
            document.getElementById('edit-product-id').value = button.dataset.id;
            document.getElementById('edit_name').value = button.dataset.name;
            document.getElementById('edit_price').value = button.dataset.price;
            document.getElementById('edit_stock').value = button.dataset.stock;
            document.getElementById('edit_description').value = button.dataset.description;
            document.getElementById('edit_thumbnail').value = button.dataset.thumbnail;
            document.getElementById('edit_category').value = button.dataset.category;
            editModal.style.display = "block";
        }
    });
    closeEditModalButton.onclick = function () { editModal.style.display = "none"; }

    // submit form edit produk via ajax
    document.getElementById('edit-product-form').addEventListener('submit', async function (event) {
        event.preventDefault();
        const productId = document.getElementById('edit-product-id').value;
        const url = `/edit-product-ajax/${productId}/`;
        const formData = new FormData(this);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: { "X-CSRFToken": csrfToken, }
            });
            const result = await response.json();
            if (response.ok) {
                showToast(result.message, 'success');
                editModal.style.display = 'none';
                getProducts();
            } else {
                showToast(result.message || "Failed to update product.", 'error');
            }
        } catch (error) {
            showToast("A connection error occurred.", 'error');
        }
    });

    // logic buat modal delete
    const deleteModal = document.getElementById('delete-confirm-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    let productIdToDelete = null;
    document.getElementById('product-grid').addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('delete-btn')) {
            productIdToDelete = event.target.dataset.id;
            deleteModal.style.display = "block";
        }
    });
    cancelDeleteBtn.onclick = function () {
        deleteModal.style.display = "none";
        productIdToDelete = null;
    }

    // konfirmasi hapus via ajax
    confirmDeleteBtn.addEventListener('click', async function () {
        if (!productIdToDelete) return;
        const url = `/delete-product-ajax/${productIdToDelete}/`;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            });
            const result = await response.json();
            if (response.ok) {
                showToast(result.message, 'success');
                deleteModal.style.display = 'none';
                getProducts();
            } else {
                showToast(result.message || "Failed to delete product.", 'error');
            }
        } catch (error) {
            showToast("A connection error occurred.", 'error');
        } finally {
            productIdToDelete = null;
        }
    });

    // logic buat modal detail
    const detailModal = document.getElementById('detail-product-modal');
    const detailModalContent = document.getElementById('detail-modal-content');
    const closeDetailModalButton = document.getElementById('close-detail-modal-button');
    document.getElementById('product-grid').addEventListener('click', async function (event) {
        const detailButton = event.target.closest('.view-detail-btn');
        if (detailButton) {
            const productId = detailButton.dataset.id;
            detailModalContent.innerHTML = '<p class="text-center p-8">Loading product details...</p>';
            detailModal.style.display = 'block';
            const url = `/json/${productId}/`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const product = data;
                const thumbnailHtml = product.fields.thumbnail
                    ? `<img src="${product.fields.thumbnail}" alt="${product.fields.name}" class="w-full h-64 object-contain bg-gray-100 rounded-t-lg">`
                    : `<div class="w-full h-64 bg-gray-200 flex items-center justify-center rounded-t-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></div>`;
                const featuredTagHtml = product.fields.is_featured ? `<span class="ml-2 inline-block bg-yellow-200 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Featured!</span>` : "";
                detailModalContent.innerHTML = `
    ${thumbnailHtml}
    <div class="p-4">
        <div class="flex items-center mb-2">
            <span class="inline-block bg-gray-100 text-gray-600 text-xs font-semibold px-2.5 py-0.5 rounded-full">${product.fields.category}</span>
            ${featuredTagHtml}
        </div>
        <h3 class="font-bold text-2xl text-gray-800">${product.fields.name}</h3>
        
        <p class="text-sm text-gray-500 mt-1">Sold by: 
            <span class="font-semibold text-gray-700">${product.fields.seller_name}</span>
        </p>

        <p class="text-gray-600 mt-2">${product.fields.description}</p>
        <div class="flex justify-between items-center mt-4 pt-4 border-t">
            <p class="text-2xl font-semibold text-emerald-600">Rp${product.fields.price.toLocaleString('id-ID')}</p>
            <p class="text-md text-gray-500">Stock: ${product.fields.stock}</p>
        </div>
    </div>
`;
            } catch (error) {
                detailModalContent.innerHTML = '<p class="text-center p-8 text-red-500">Failed to load product details. Please try again.</p>';
                console.error("Failed to fetch product details:", error);
            }
        }
    });
    closeDetailModalButton.onclick = function () {
        detailModal.style.display = 'none';
    };
</script>

{% endblock main_content %}